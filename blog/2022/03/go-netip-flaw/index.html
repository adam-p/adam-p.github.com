<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=google-site-verification content="WxZdzPANRFpehqogDMcTc9HLGXXDJy5If07MuUZvHho"><link rel=icon type=image/png href=../../../../favicon.png><link rel=stylesheet href=../../../../scss/styles.css><title>A tiny flaw in Go's netip design | adam-p</title></head><body><nav class="navbar navbar-expand-md navbar-light bg-light"><div class=container-fluid><a class=navbar-brand href=../../../../>adam-p</a>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarNav aria-controls=navbarNav aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarNav><ul class=navbar-nav><li class=nav-item><a class=nav-link href=../../../../blog/>Blog</a></li><li class=nav-item><a class=nav-link href=../../../../inco/>In/Co</a></li><li class=nav-item><a class=nav-link href=../../../../projects/>Projects</a></li><li class=nav-item><a class=nav-link href=../../../../cv/>CV</a></li></ul></div></div></nav><div class=container-fluid><section><h1 class=title><a href=../../../../blog/2022/03/go-netip-flaw/>A tiny flaw in Go's netip design</a></h1><h5 class=text-end>March 21, 2022</h5><div><article><p>Update 2022-03-23: Matt Layher <a href=https://github.com/golang/go/issues/51899>created a Go issue</a> about this.</p><p>Update 2022-04-14: In response to that issue, two weeks ago a change <a href=https://github.com/golang/go/commit/ae9ce822ff4015fbbe7aa4303e6f3c160f2c53af>was committed</a> to Go that makes <code>netip.ParsePrefix</code> behave like <code>net.ParseCIDR</code>: they both return an error when a zone is present. It wasn&rsquo;t released in 1.18.1, but I&rsquo;m guessing it&rsquo;ll be in 1.18.2. So that&rsquo;s great!</p><hr><p>Does this surprise you? (Try it in the <a href=https://go.dev/play/p/4bHXBiBktUH>playground</a>.)</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#75af00>prefix</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>netip</span><span style=color:#111>.</span><span style=color:#75af00>MustParsePrefix</span><span style=color:#111>(</span><span style=color:#d88200>&#34;fe80::%zone/10&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>addr</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>netip</span><span style=color:#111>.</span><span style=color:#75af00>MustParseAddr</span><span style=color:#111>(</span><span style=color:#d88200>&#34;fe80::1%zone&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>prefix</span><span style=color:#111>.</span><span style=color:#75af00>Contains</span><span style=color:#111>(</span><span style=color:#75af00>addr</span><span style=color:#111>))</span> <span style=color:#75715e>// ==&gt; false
</span></span></span></code></pre></div><p>Go&rsquo;s new-as-of-1.18 <a href=https://pkg.go.dev/net/netip><code>netip</code> package</a> is better in every way than the previous <code>net.IP</code>, etc., but this one design decision will probably burn someone, somewhere, sometime.</p><p>If you pass a prefix with a zone to the older <code>net.ParseCIDR</code> it returns an error. If you pass a prefix with a zone to the newer <code>netip.ParsePrefix</code>, it succeeds but silently discards the zone. If you then pass an IP address that is clearly contained by the original prefix &ndash; <em>including the zone</em> &ndash; to <code>netip.Prefix.Contains</code>&mldr; it returns false!</p><h2 id=why-is-it-like-this><a class=heading-anchor href=#why-is-it-like-this>##</a>
Why is it like this?</h2><p>I learned about this from <a href=https://old.reddit.com/r/ipv6/comments/thyhcn/does_it_make_sense_and_is_it_legal_to_have_a_zone/i1by8n5/>a Reddit comment</a> by <a href=https://github.com/mdlayher>Matt Layher</a><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> who worked on <code>netip</code> (or the original <code>inet.af/netaddr</code>):</p><blockquote><p>For what it&rsquo;s worth, I helped work on the library that ultimately became Go&rsquo;s net/netip and we decided we would remove zones in our CIDR prefix parser because we didn&rsquo;t find any documented usage of a a CIDR like &ldquo;fe80::%eth0/64&rdquo; in the wild.</p></blockquote><p>Which is fair, but I don&rsquo;t think the resulting behaviour is ideal.</p><h2 id=what-do-the-docs-say><a class=heading-anchor href=#what-do-the-docs-say>##</a>
What do the docs say?</h2><p>The <a href=https://pkg.go.dev/net/netip@go1.18#Prefix.Contains>documentation</a> for <code>netip.Prefix.Contains</code> does make clear the behaviour (emphasis added):</p><blockquote><p>Contains reports whether the network p includes ip.</p><p>An IPv4 address will not match an IPv6 prefix. A v6-mapped IPv6 address will not match an IPv4 prefix. A zero-value IP will not match any prefix. <strong>If ip has an IPv6 zone, Contains returns false, because Prefixes strip zones.</strong></p></blockquote><p>It&rsquo;s good that it&rsquo;s documented, but&mldr; how many people are going to read the doc for that method? Most people who use it are going to know what it means for a prefix (or CIDR) to &ldquo;contain&rdquo; an IP address. And many of us will already be familiar with the older <code>net.IPMask.Contains</code>, which has the one-sentence <a href=https://pkg.go.dev/net@go1.18#IPNet.Contains>documentation</a>: &ldquo;Contains reports whether the network includes ip.&rdquo; And the <a href=https://pkg.go.dev/net/netip@go1.18#ParsePrefix>doc</a> for <code>netip.ParsePrefix</code> says nothing about discarding the zone.</p><h2 id=why-do-i-care-about-this-fringe-thing-that-no-one-uses><a class=heading-anchor href=#why-do-i-care-about-this-fringe-thing-that-no-one-uses>##</a>
Why do I care about this fringe thing that no one uses?</h2><p>I&rsquo;m writing a <a href=https://github.com/realclientip/realclientip-go>library</a> that will take a configured list of prefixes/CIDRs/ranges, parse them, and then later check if incoming IPs are contained by them. And whether the IP is contained or not could lead to security-relevant decisions, so the accuracy is important.</p><p>With the older <code>net</code> package, if the user tried to configure the library to use <code>"fe80::/10%zone"</code>, the parsing would fail and there would be an immediate error. If I switch to using <code>netip</code>, the parsing will succeed but then the <code>Contains</code> checks will return false and the resulting behaviour will be wrong. (The ramifications of that will depend on how the library is being used. It could mean rate-limiting a link-local IP. It could mean using a link-local IP for an access control check where it should instead be an external IP.)</p><p>So even though the Go/netip/netaddr team didn&rsquo;t find any instance of a link-local-with-zone-prefix &ldquo;in the wild&rdquo;, I still need to code (defensively) for the possibility of it.</p><p>To be safe I&rsquo;m going to have to force the <code>netip</code> code to behave like the <code>net</code> code: return an error from the prefix parsing code if there&rsquo;s a percent sign.</p><h2 id=bonus-ipv4-mapped-ipv6-handling-has-also-changed><a class=heading-anchor href=#bonus-ipv4-mapped-ipv6-handling-has-also-changed>##</a>
Bonus: IPv4-mapped IPv6 handling has also changed</h2><p>As hinted at in the <code>netip.Prefix.Contains</code> doc I quoted above&mldr;</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#75af00>prefix</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>netip</span><span style=color:#111>.</span><span style=color:#75af00>MustParsePrefix</span><span style=color:#111>(</span><span style=color:#d88200>&#34;1.0.0.0/8&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Let&#39;s check that it&#39;s working as expected
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>addr</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>netip</span><span style=color:#111>.</span><span style=color:#75af00>MustParseAddr</span><span style=color:#111>(</span><span style=color:#d88200>&#34;1.1.1.1&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>prefix</span><span style=color:#111>.</span><span style=color:#75af00>Contains</span><span style=color:#111>(</span><span style=color:#75af00>addr</span><span style=color:#111>))</span> <span style=color:#75715e>// ==&gt; true
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Now let&#39;s try the &#34;IPv4-mapped IPv6&#34; representation of the same address
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>addr</span> <span style=color:#111>=</span> <span style=color:#75af00>netip</span><span style=color:#111>.</span><span style=color:#75af00>MustParseAddr</span><span style=color:#111>(</span><span style=color:#d88200>&#34;::ffff:1.1.1.1&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>addr</span><span style=color:#111>)</span>                  <span style=color:#75715e>// ==&gt; &#34;::ffff:1.1.1.1&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>prefix</span><span style=color:#111>.</span><span style=color:#75af00>Contains</span><span style=color:#111>(</span><span style=color:#75af00>addr</span><span style=color:#111>))</span> <span style=color:#75715e>// ==&gt; false!
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// But with the older net.IP and net.NetIP...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>_</span><span style=color:#111>,</span> <span style=color:#75af00>cidr</span><span style=color:#111>,</span> <span style=color:#75af00>_</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>net</span><span style=color:#111>.</span><span style=color:#75af00>ParseCIDR</span><span style=color:#111>(</span><span style=color:#d88200>&#34;1.0.0.0/8&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>ip</span> <span style=color:#f92672>:=</span> <span style=color:#75af00>net</span><span style=color:#111>.</span><span style=color:#75af00>ParseIP</span><span style=color:#111>(</span><span style=color:#d88200>&#34;::ffff:1.1.1.1&#34;</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>ip</span><span style=color:#111>)</span>                <span style=color:#75715e>// ==&gt; &#34;1.1.1.1&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75af00>fmt</span><span style=color:#111>.</span><span style=color:#75af00>Println</span><span style=color:#111>(</span><span style=color:#75af00>cidr</span><span style=color:#111>.</span><span style=color:#75af00>Contains</span><span style=color:#111>(</span><span style=color:#75af00>ip</span><span style=color:#111>))</span> <span style=color:#75715e>// ==&gt; true!
</span></span></span></code></pre></div><p>(Try it in the <a href=https://go.dev/play/p/ANR5tJEDohN>playground</a>.)</p><p>The older <code>net</code> code would convert IPv4-mapped IPv6 addresses to IPv4 addresses, with the result that they would be contained by IPv4 CIDRs. The new <code>netip</code> code does <em>not</em> convert to IPv4, and the resulting address is <em>not</em> contained by an IPv4 prefix.</p><p>I haven&rsquo;t yet thought about this enough to form a strong opinion, but it&rsquo;s good to know.</p><p>Update 2022-04-14: I <a href=https://github.com/golang/go/issues/51906>created an issue</a> about this a few weeks ago. (I also <a href=https://github.com/golang/go/pull/51950>PR&rsquo;d some documentation fixes</a> regarding the consistent use of &ldquo;IPv4-mapped IPv6&rdquo;. It&rsquo;s been merged.)</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Who super helpfully answered my Reddit question and I&rsquo;m totally not taking a swipe at him. To be clear, I still think <code>netip</code> is great and will be using it wherever I can make 1.18 the minimum Go version.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></article></div></section><hr><aside><p><h5>802 Words</h5></p><p>Last Update:
<time datetime="Thu Apr 40 47:42:28 14140 -0400" class=text-muted>April 14, 2022</time><br><a href=https://github.com/adam-p/adam-p.github.com/commits/master/content/blog/2022-03-21-go-netip-flaw.md>See revision history</a></p><p><h5>Tags</h5><ul id=tags><li><a href=../../../../tags/golang>golang</a></li><li><a href=../../../../tags/ipv6>ipv6</a></li></ul></p><p>Next: <a class=next href=../../../../blog/2022/03/strip-ipv6-zone/>Should you strip the IPv6 zone?</a><br>Previous: <a class=previous href=../../../../blog/2022/03/x-forwarded-for/>The perils of the “real” client IP</a></p></aside><footer class=text-end><small>© 2022 Adam Pritchard</small></footer></div><script src=../../../../node_modules/bootstrap/dist/js/bootstrap.js></script></body></html>